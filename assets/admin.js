$(function(){let e,t;function a(){$("#Update, #Add").on("change",function(){$('input[type="submit"]',this).prop("disabled",!1)}),$("#Update").submit(function(e){let t=$(this);e.preventDefault(),$.ajax({url:$_BASEURL+t.attr("data-request"),method:"post",data:new FormData(this),dataType:"json",contentType:!1,cache:!1,processData:!1,beforeSend:function(){},success:function(e){console.log(e.data),"ok"===e.status?(f(e.status,e.message),$('input[type="submit"]',t).prop("disabled",!0)):f(e.status,e.message+" Код ошибки: "+e.code)},error:function(e){f(e.status,e.message+" Код ошибки: "+e.code)}})})}function n(){(e=$("#Selector .grd")).sortable({items:"a.item:not(.unsortable)",disabled:!0}),e.disableSelection(),$("#Selector .edit-order").on("click",function(){if(e.hasClass("editing")){$(e).sortable("disable"),e.removeClass("editing"),$(this).text("Редактировать порядок");let t=$(this).attr("data-slug"),a=$(this).attr("data-table");$.ajax({url:$_BASEURL+"updateOrder",method:"post",data:{table:a,slug:t,order:function(){let t={};return $("> .item:not(.unsortable)",e).each(function(){t[$(this).index()]=$(this).attr("data-slug")}),console.log(t),t}()},dataType:"json",beforeSend:function(){},success:function(e){"ok"===e.status?f(e.status,e.message):f(e.status,e.message+" Код ошибки: "+e.code)},error:function(e){f(e.status,e.message+" Код ошибки: "+e.code)}})}else!function(e){$(e).sortable("enable")}(e),e.addClass("editing"),$(this).text("Сохранить изменения")})}const s=e=>{$.ajax({url:e.dataset.delete,data:new FormData(e),method:"post",dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(t){console.log(t),"ok"===t.status?($(e).remove(),f(t.status,t.message)):f(t.status,t.message)},error:function(e){console.log(e),f(e.status,e.message)}})},o=e=>{$.ajax({url:e.dataset.update,data:new FormData(e),method:"post",dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(e){console.log(e),f(e.status,e.message)},error:function(e){console.log(e),f(e.status,e.message)}})},r=e=>{$.ajax({url:e.dataset.delete,data:new FormData(e),method:"post",dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(t){console.log(t),"ok"===t.status&&$(e).remove(),f(t.status,t.message)},error:function(e){console.log(e),f(e.status,e.message)}})},c=e=>{$.ajax({url:e.dataset.add,data:new FormData(e),method:"post",dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(t){if(console.log(t),"ok"===t.status){const a=$(e).parent(),n=$(e).clone(),s=$(e).find('button[type="submit"]');s.text("Обновить"),s.removeClass("price__btn--add"),s.addClass("price__btn--update"),$(e).attr("id",`price${t.data.id}`),$(e).append('<button class="price__btn price__btn--delete" type="button">Удалить</button>'),$(e).find('input[name="id"]').val(t.data.id),$(e).on("submit",t=>{t.preventDefault(),o($(e)[0])}),$(".price__btn--delete",e).on("click",t=>{t.preventDefault(),r(e)}),a.append(n),$(n)[0].reset(),$(n).on("submit",e=>{e.preventDefault(),c(n[0])})}f(t.status,t.message)},error:function(e){console.log(e),f(e.status,e.message)}})};document.querySelectorAll('form[name="price"]').forEach(e=>{e.addEventListener("submit",t=>{t.preventDefault(),o(e)});const t=e.querySelector(".price__btn--delete");t.addEventListener("click",a=>{a.preventDefault(),r(e,t.dataset.action)})});const i=document.querySelector('form[name="price-new"]');i&&i.addEventListener("submit",e=>{e.preventDefault(),c(i)});const l=()=>{const e=document.querySelector("#mass-uploader"),t=document.querySelector(".js-mass-uploader");if(!e||!t)return;const a=t.querySelector('[name="max_size"]'),n=t.querySelector('[name="mime"]'),s=t.querySelector('[name="min_width"]'),o=t.querySelector('[name="max_width"]'),r=t.querySelector('[name="min_height"]'),c=t.querySelector('[name="max_height"]');e.addEventListener("change",()=>{console.log("1");const i=new FormData(t);const l=[...e.files];if(l.length>15)return void alert("Нельзя загружать более 10 файлов");if(0===l.length)return;const u=[];l.forEach(e=>{u.push((e=>{const t=[];if(a){const n=parseInt(a.value);e.size>n&&t.push(`Размер файла ${e.name} превышает допустимый`)}if(n){const a=n.value;e.type!==a&&t.push(`Файл ${e.name} имеет неверный формат`)}if(t.length)return new Promise((e,a)=>{a(t)});const i=new FileReader;return i.readAsDataURL(e),new Promise((t,a)=>{i.onerror=(t=>{a(`Файл ${e.name} поврежден`)}),i.onload=(n=>{const i=new Image;i.src=n.target.result,i.onload=(()=>{const n=i.height,l=i.width,u=`Файл ${e.name} не соответствует требованиям ширины или высоты`;s&&l<parseInt(s.value)&&a(u),o&&l>parseInt(o.value)&&a(u),r&&n<parseInt(r.value)&&a(u),c&&n>parseInt(c.value)&&a(u),t(!0)})})})})(e))}),console.log("2"),Promise.allSettled(u).then(e=>{const a=e.filter(e=>"rejected"===e.status).map(e=>e.reason);if(a.length){let e="";return a.forEach(t=>{e+=t+"\n"}),void alert(e)}((e,a)=>{$.ajax({url:$_BASEURL+"uploadMassImage",method:"post",data:e,dataType:"json",contentType:!1,cache:!1,processData:!1,xhr:function(){let e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){let t=e.loaded/e.total;p(a,t)}},!1),e},beforeSend:function(){(a=d("Загрузка...")).appendTo($(".input-group.file",t))},success:function(e){if(console.log(e),"ok"===e.status)f(e.status,e.message+"<br>Перезагрузка..."),window.setTimeout(()=>{window.location.reload()},1500);else if("fail"===e.status)f(e.status,e.message+" Код ошибки: "+e.code);else if(e.validate_errors){let t="";e.validate_errors.forEach(e=>{t+=`Файл ${e.image} ${e.message}`+"\n"}),alert(t)}else if(e.server_errors){let t="Не все файлы были загружены:";e.validate_errors.forEach(e=>{t+=`Файл ${e.image} ${e.message}`+"\n"}),t+="Страница будет перезагружена",alert(t),window.setTimeout(()=>{window.location.reload()},1e3)}else f(e.status,"Что-то пошло не так, обратитесь к администратору");m(a)},error:function(e){console.log(e),f(e.status,e.message+" Код ошибки: "+e.code),m(a)}})})(i,void 0)})})};function u(){$(".js-single-uploader").each(function(){$(this).on("change",function(){$(this).submit()}),$(this).submit(function(e){e.preventDefault();let t,a=$(this),n=new FormData($(this)[0]);$.ajax({url:$_BASEURL+"uploadImage",method:"post",data:n,dataType:"json",contentType:!1,cache:!1,processData:!1,xhr:function(){let e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){let a=e.loaded/e.total;p(t,a)}},!1),e},beforeSend:function(){(t=d("Загрузка...")).appendTo($(".input-group.file",a))},success:function(e){console.log(e),"ok"===e.status?(f(e.status,e.message),window.setTimeout(()=>{$(".img > img",a).attr("src",e.path+"?t="+(new Date).getTime())},1500)):f(e.status,e.message+" Код ошибки: "+e.code),m(t)},error:function(e){console.log(e),f(e.status,e.message+" Код ошибки: "+e.code),m(t)}})})})}function d(e){return $('<div class="progress-block"><p>'+e+'</p><div class="progress"><div class="bar"></div></div></div>')}function m(e){e.remove()}function p(e,t){let a=t*e.width();e.find(".bar").stop().animate({left:a},2500)}function f(e,a,n){let s=$('<div class="item '+e+'">'+a+"</div>").appendTo(t);setTimeout(function(){s.length>0&&s.remove()},n||5e3)}function g(e,t){return t-(e.value.slice(0,t).split("\r\n").length-1)}function h(e,t){var a=function(e){var t,a,n,s,o,r=0,c=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(r=e.selectionStart,c=e.selectionEnd):(a=document.selection.createRange())&&a.parentElement()==e&&(s=e.value.length,t=e.value.replace(/\r\n/g,"\n"),(n=e.createTextRange()).moveToBookmark(a.getBookmark()),(o=e.createTextRange()).collapse(!1),n.compareEndPoints("StartToEnd",o)>-1?r=c=s:(r=-n.moveStart("character",-s),r+=t.slice(0,r).split("\n").length-1,n.compareEndPoints("EndToEnd",o)>-1?c=s:(c=-n.moveEnd("character",-s),c+=t.slice(0,c).split("\n").length-1))),{start:r,end:c}}(e).end,n=a+t.length,s=e.value;e.value=s.slice(0,a)+t+s.slice(a),e.focus(),function(e,t,a){if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd)e.selectionStart=t,e.selectionEnd=a;else if(void 0!==e.createTextRange){var n=e.createTextRange(),s=g(e,t);n.collapse(!0),t==a?n.move("character",s):(n.moveEnd("character",g(e,a)),n.moveStart("character",s)),n.select()}}(e,n,n)}$(document).ready(function(e){t=e("#Notifications"),a(),n(),u(),document.querySelectorAll(".image-delete").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.parentNode;s(t)})}),l()}),$("#delete-form").on("submit",e=>{window.confirm("Вы уверены? Восстановление невозможно")||e.preventDefault()});const v=document.querySelectorAll(".wysiwyg"),b=e=>{const t=[...e.value.matchAll(/\d.jpg/gi)];return t.length?t.map(e=>parseInt(e[0].replace(/D/,""))).sort().pop():0};document.querySelectorAll(".w-js").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const a=(e=>{return[...v].find(t=>t.getAttribute("name")===e)})(e.dataset.name);if(a){h(a,((e,t)=>{switch(e){case"p":return"<p>\n\n</p>\n";case"bold":return"<b></b>";case"italic":return"<i></i>";case"underline":return'<span class="u"></span>';case"heading":return'<div class="h"></div>\n';case"h2":return"<h2></h2>\n";case"h3":return"<h3></h3>\n";case"ul":return"<ul>\n<li></li>\n</ul>\n";case"ol":return"<ol>\n<li></li>\n</ol>\n";case"item":return"<li></li>\n";case"img":return`<img src="${t.dataset.image_path}${t.dataset.id}/gallery/gallery-${b(t)+1}.jpg">\n`;case"group":return`<div class="gallery">\n<img src="${t.dataset.image_path}${t.dataset.id}/gallery/gallery-${b(t)+1}.jpg">\n</div>\n`;default:return""}})(e.dataset.type,a))}})});(()=>{const e=document.querySelectorAll('[name="sycret_sync"]');if(!e.length)return;const t=document.querySelector('[name="sycret_id"]');if(t&&!t.value)return void e[0].parentElement.remove();const a=document.querySelector('[name="name"]'),n=document.querySelector('[name="description"]'),s=document.querySelector('[name="position"]'),o=()=>e.forEach(e=>{"1"===e.value&&(e.checked?(a&&a.setAttribute("disabled","disabled"),n&&n.setAttribute("disabled","disabled"),s&&s.setAttribute("disabled","disabled")):(a&&a.removeAttribute("disabled"),n&&n.removeAttribute("disabled"),s&&s.removeAttribute("disabled")))});o(),e.forEach(e=>{e.addEventListener("change",o)})})()});